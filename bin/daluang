#!/usr/bin/python

import sys
from daluang import Config, Converter, Reader, Locator

#
# Usage
#

def usage():
	print """Usage: daluang <command> [cmd-opt ...]

Available commands:

- convert : convertes a wikipedia dump file
- list    : lists all installed wikipedia files
- read    : reads a wikipedia entry
- help    : help for other commands"""

#
# Help
#
def cmd_help():
	if len(sys.argv) < 3:
		cmd = 'help'
	else:
		cmd = sys.argv[2]
	
	cmds = apps.keys()
	if cmd in cmds:
		func = apps[cmd][1]
		func()
	else:
		print "Available commands: %s" % (" ".join(cmds))

def usage_help():
	print "Usage: daluang help <dommand>"

#
# Index
#
def cmd_convert():
	if len(sys.argv) < 5:
		usage_convert()
		sys.exit(1)

	language = sys.argv[2];
	code = sys.argv[3];
	input = sys.argv[4];

	if input.endswith('.xml.bz2'):
		base = input[:-8]
	elif input.endswith('.bz2'):
		base = input[:-4]
	else:
		base = input

	output = base + ".data"

	converter = Converter(input, output)
	converter.set_language(language)
	converter.set_code(code)
	converter.convert()
	

def usage_convert():
	print """Usage: daluang convert <language> <code> <data>

<data> is an XML database dump of Wikipedia. 
Usually it is written in the following format:

    idwiki-20080213-pages-articles.xml.bz2
	
Example usage:

    daluang convert "Bahasa Indonesia" "id" idwiki-20080213-pages-articles.xml.bz2"""

#
# Read
#
def cmd_read():
	if len(sys.argv) < 4:
		usage_read()
		sys.exit(1)

	data = sys.argv[2]
	title = sys.argv[3]

	r = Reader(data)
	result = r.read(title)
	if result == None:
		print "Not found: %s" % title
	else:
		title2, content = result
		print content

def usage_read():
	# TODO
	print "Usage: daluang read <datafile> <title>"
	pass

#
# List
#
def cmd_list():
	# TODO
	pass

def usage_list():
	# TODO
	pass

#
# Main
#

apps = {
	'help' : [cmd_help, usage_help],
	'convert': [cmd_convert, usage_convert],
	'read' : [cmd_read, usage_read],
	'list' : [cmd_list, usage_list]
}

if len(sys.argv) < 2:
	usage()
	sys.exit(1)

cmd = sys.argv[1]

cmds = apps.keys()
if cmd in cmds:
	func = apps[cmd][0]
	func()
else:
	usage()

